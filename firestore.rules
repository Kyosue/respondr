rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      // Allow read for authenticated users
      allow read: if request.auth != null;
      
      // Allow list queries (for username lookup during login)
      // This is necessary for username-based login before authentication
      // Note: This allows querying the collection, but individual document reads still require auth
      allow list: if true;
      
      // Allow users to update their own data
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Allow only admins to manage all users (supervisors restricted)
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin'));
    }
    
    // Resources collection
    match /resources/{resourceId} {
      allow read, write: if request.auth != null;
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null;
    }
    
    // Multi-transactions collection
    match /multiTransactions/{multiTransactionId} {
      allow read, write: if request.auth != null;
    }
    
    // Borrowers collection
    match /borrowers/{borrowerId} {
      allow read, write: if request.auth != null;
    }
    
    // Resource history collection
    match /resourceHistory/{historyId} {
      allow read, write: if request.auth != null;
    }
    
    // Agencies collection
    match /agencies/{agencyId} {
      allow read, write: if request.auth != null;
    }
    
    // SitRep Documents collection - CRITICAL: Added for document management
    match /sitrep_documents/{documentId} {
      // Allow read for all authenticated users (as per user requirement)
      allow read: if request.auth != null;
      
      // Allow write (create, update, delete) for all authenticated users
      // This matches the user's requirement that "all users that logs in can access the sitrep and everything in it"
      allow write: if request.auth != null;
      
      // Optional: More restrictive rules if needed in the future
      // allow create: if request.auth != null && 
      //   request.resource.data.uploadedBy == request.auth.uid;
      // allow update: if request.auth != null && 
      //   (resource.data.uploadedBy == request.auth.uid || 
      //    request.resource.data.uploadedBy == request.auth.uid);
      // allow delete: if request.auth != null && 
      //   resource.data.uploadedBy == request.auth.uid;
    }
    
    // Memo Documents collection - NEW: Added for memo and local issuance management
    match /memo_documents/{documentId} {
      // Allow read for all authenticated users
      allow read: if request.auth != null;
      
      // Allow write (create, update, delete) for all authenticated users
      // This matches the same pattern as sitrep_documents for consistency
      allow write: if request.auth != null;
      
      // Optional: More restrictive rules if needed in the future
      // allow create: if request.auth != null && 
      //   request.resource.data.uploadedBy == request.auth.uid;
      // allow update: if request.auth != null && 
      //   (resource.data.uploadedBy == request.auth.uid || 
      //    request.resource.data.uploadedBy == request.auth.uid);
      // allow delete: if request.auth != null && 
      //   resource.data.uploadedBy == request.auth.uid;
    }
    
    // Custom Weather Stations collection - NEW: Added for syncing custom weather stations across devices
    match /custom_weather_stations/{stationId} {
      // Allow read for all authenticated users
      allow read: if request.auth != null;
      
      // Allow write (create, update, delete) for all authenticated users
      // This allows users to add custom weather stations that sync across their devices
      allow write: if request.auth != null;
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications (both get and list operations)
      // For list queries, we allow authenticated users to query their own notifications
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      
      // Allow list queries for authenticated users
      // This is needed for onSnapshot with queries - the query filters by userId
      allow list: if request.auth != null;
      
      // Users can update their own notifications (mark as read)
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // Only system can create notifications (via Cloud Functions or authenticated users)
      allow create: if request.auth != null;
      
      // Users cannot delete notifications (soft delete via update)
      allow delete: if false;
    }
  }
}

